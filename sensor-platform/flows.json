[
    {
        "id": "0b9edc73aec51869",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "a1f20c68c2fa4a56",
        "type": "inject",
        "z": "0b9edc73aec51869",
        "name": "Request IO-Link Data",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "5",
        "crontab": "",
        "once": true,
        "onceDelay": "1",
        "topic": "",
        "payload": "{\"code\":10,\"cid\":4711,\"adr\":\"/iolinkmaster/port[3]/iolinkdevice/pdin/getdata\"}",
        "payloadType": "json",
        "x": 220,
        "y": 480,
        "wires": [
            [
                "1b82c7b04bcaf4f5"
            ]
        ]
    },
    {
        "id": "1b82c7b04bcaf4f5",
        "type": "http request",
        "z": "0b9edc73aec51869",
        "name": "Send to IO-Link Master",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "192.168.1.10",
        "tls": "",
        "persist": true,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 470,
        "y": 480,
        "wires": [
            [
                "99eaf1e4aa410e8b",
                "da554782a4d1dda6"
            ]
        ]
    },
    {
        "id": "99eaf1e4aa410e8b",
        "type": "function",
        "z": "0b9edc73aec51869",
        "name": "Decode HEX â†’ Integer",
        "func": "// ===============================\n// 1ï¸âƒ£ Identify sensor and decode\n// ===============================\n\nlet hex = msg.payload.data?.value;\nif (!hex) {\n    node.warn(\"No hex data found in payload\");\n    return null;\n}\n\nhex = hex.replace(/\\s+/g, \"\");\nlet b = Buffer.from(hex, \"hex\");\n\nlet doc = {}; // final document for Elasticsearch\n\n// ----------------------------------------\n// ðŸª„ Detect sensor type by frame length\n// ----------------------------------------\nif (b.length === 20) {\n    // ===== VVB001: 20-byte vibration sensor frame =====\n    function s16(i) {\n        return b.readInt16LE(i);\n    }\n\n    // Raw values\n    let v_rms_raw       = s16(0);\n    let a_peak_raw      = s16(2);\n    let a_rms_raw       = s16(4);\n    let temperature_raw = s16(6);\n    let crest_raw       = s16(8);\n\n    // Physical conversions (from IFM IODD)\n    let v_rms       = Number((v_rms_raw * 0.0001).toFixed(4));  // m/s\n    let a_peak      = Number((a_peak_raw * 0.1).toFixed(1));    // m/sÂ²\n    let a_rms       = Number((a_rms_raw * 0.1).toFixed(1));     // m/sÂ²\n    let temperature = Number((temperature_raw * 0.1).toFixed(1)); // Â°C\n    let crest       = Number((crest_raw * 0.1).toFixed(1));     // ratio\n\n    // Status + outputs\n    let status = b[10];\n    let device_status = status & 0x0F;\n    let out2 = (status >> 4) & 0x01;\n    let out1 = (status >> 5) & 0x01;\n\n    doc = {\n        sensor_type: \"vibration\",\n        v_rms,\n        a_peak,\n        a_rms,\n        temperature,\n        crest,\n        device_status,\n        out2,\n        out1,\n        raw_hex: hex,\n        timestamp: new Date().toISOString()\n    };\n}\n// ----------------------------------------\n// ðŸª„ Ultrasonic Sensor (distance only)\n// ----------------------------------------\nelse if (b.length === 4) {\n    // Example: \"0106FD02\" â†’ distance in mm\n    let low = b[3];   // last byte\n    let high = b[2];  // third byte\n    let raw = (low << 8) + high;\n\n    // Apply scale factor (depends on calibration)\n    let distance_mm = Math.round(raw * 0.342);\n\n    doc = {\n        sensor_type: \"ultrasonic\",\n        raw_hex: hex,\n        raw_value: raw,\n        distance_mm,\n        timestamp: new Date().toISOString()\n    };\n}\n// ----------------------------------------\n// âŒ Unknown frame size\n// ----------------------------------------\nelse {\n    node.warn(`Unknown sensor frame length: ${b.length} bytes`);\n    return null;\n}\n\n// ===============================\n// 2ï¸âƒ£ Send to Elasticsearch\n// ===============================\nmsg.method = \"POST\";\nmsg.url = \"http://localhost:9200/sensor_data/_doc\";\nmsg.headers = { \"Content-Type\": \"application/json\" };\nmsg.payload = doc;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 480,
        "wires": [
            [
                "f318f4bd12a26f1f"
            ]
        ]
    },
    {
        "id": "eb8ce40dbb005b96",
        "type": "http request",
        "z": "0b9edc73aec51869",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "http://localhost:9200/sensor_data/_doc",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "basic",
        "senderr": false,
        "headers": [
            {
                "keyType": "Content-Type",
                "keyValue": "",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1370,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "f318f4bd12a26f1f",
        "type": "function",
        "z": "0b9edc73aec51869",
        "name": "http fun",
        "func": "let data = msg.payload;\n\n// 1ï¸âƒ£ Safety check â€” must not be raw IO-Link data\nif (data.data && data.data.value) {\n    node.warn(\"Received raw IO-Link data â€” decoding function not applied yet.\");\n    return null;\n}\n\n// 2ï¸âƒ£ Validate decoded data\nif (!data.sensor_type) {\n    node.warn(\"No sensor_type field found â€” cannot route data.\");\n    return null;\n}\n\n// 3ï¸âƒ£ Configure Elasticsearch endpoint based on sensor type\nlet indexName = \"sensor_data\";  // default index\n\nif (data.sensor_type === \"vibration\") {\n    indexName = \"vibration_data\";\n} else if (data.sensor_type === \"ultrasonic\") {\n    indexName = \"ultrasonic_data\";\n}\n\n// 4ï¸âƒ£ Build Elasticsearch HTTP request\nmsg.method = \"POST\";\nmsg.url = `http://localhost:9200/${indexName}/_doc`;\nmsg.headers = { \"Content-Type\": \"application/json\" };\nmsg.payload = data;\n\n// Log whatâ€™s being sent (for debugging)\nnode.warn(`Sending ${data.sensor_type} data to index: ${indexName}`);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 480,
        "wires": [
            [
                "eb8ce40dbb005b96"
            ]
        ]
    },
    {
        "id": "2559740759728e9a",
        "type": "inject",
        "z": "0b9edc73aec51869",
        "name": "Reqest IO-Link VVB Sensor Data",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"code\":10,\"cid\":4711,\"adr\":\"/iolinkmaster/port[4]/iolinkdevice/pdin/getdata\"}",
        "payloadType": "json",
        "x": 240,
        "y": 320,
        "wires": [
            [
                "18085f0f822b166f"
            ]
        ]
    },
    {
        "id": "18085f0f822b166f",
        "type": "http request",
        "z": "0b9edc73aec51869",
        "name": "Send to IO-Link Master",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "192.168.1.10",
        "tls": "",
        "persist": true,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 530,
        "y": 320,
        "wires": [
            [
                "99eaf1e4aa410e8b",
                "943b380f3ed11b2f"
            ]
        ]
    },
    {
        "id": "da554782a4d1dda6",
        "type": "debug",
        "z": "0b9edc73aec51869",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 710,
        "y": 640,
        "wires": []
    },
    {
        "id": "943b380f3ed11b2f",
        "type": "debug",
        "z": "0b9edc73aec51869",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 160,
        "wires": []
    }
]
